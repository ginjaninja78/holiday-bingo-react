# Manus Agent Instructions for Holiday Bingo Project

## Project Overview

**Holiday Image Bingo** is a production-ready, corporate-friendly web application for hosting real-time multiplayer bingo games with winter-themed imagery. The project uses React 19, TypeScript, Express, tRPC, Socket.IO, and MySQL/TiDB.

## Core Responsibilities

As an AI agent working on this project, you are responsible for:

1. **Code Maintenance**: Fix bugs, add features, and refactor code
2. **Testing**: Write and maintain vitest tests for all new features
3. **Documentation**: Keep README and inline documentation up to date
4. **Database Management**: Handle schema changes and migrations
5. **Security**: Ensure all changes maintain security standards
6. **Progress Tracking**: Update todo.md and log daily progress

## Architecture Understanding

### Directory Structure

```
/holiday-bingo
├── client/src/          # Frontend React application
│   ├── components/      # Reusable UI components
│   ├── pages/          # Route pages
│   └── lib/            # Client utilities
├── server/             # Backend Express + tRPC
│   ├── _core/         # Framework internals (DO NOT MODIFY)
│   ├── gameRouter.ts  # Game API endpoints
│   ├── websocket.ts   # Real-time communication
│   └── db.ts          # Database queries
├── core/              # Pure TypeScript game logic
├── drizzle/           # Database schema
└── shared/            # Shared types
```

### Key Technologies

- **Frontend**: React 19, TypeScript, TailwindCSS 4, shadcn/ui, tRPC client
- **Backend**: Express 4, tRPC 11, Socket.IO, Drizzle ORM
- **Database**: MySQL/TiDB with Drizzle ORM
- **Testing**: Vitest
- **Real-time**: Socket.IO for WebSocket communication

## Development Workflow

### 1. Before Making Changes

```bash
# Always start by checking current state
pnpm check          # Type checking
pnpm test           # Run tests
git status          # Check uncommitted changes
```

### 2. Making Changes

**For New Features:**
1. Add unchecked item to `todo.md`
2. Implement feature with proper TypeScript types
3. Write vitest tests in `server/*.test.ts`
4. Update relevant documentation
5. Mark item as complete in `todo.md`

**For Bug Fixes:**
1. Identify root cause
2. Write failing test that reproduces bug
3. Fix the bug
4. Verify test passes
5. Document fix in commit message

**For Database Changes:**
1. Edit `drizzle/schema.ts`
2. Run `pnpm db:push` to apply changes
3. Update `server/db.ts` with new query helpers
4. Update tRPC routers to use new schema
5. Test thoroughly

### 3. Testing Requirements

**Always write tests for:**
- Game engine logic (in `server/gameEngine.test.ts`)
- tRPC procedures (create `server/*.test.ts`)
- Database query helpers
- Validation logic

**Test command:**
```bash
pnpm test
```

### 4. Code Quality

**TypeScript:**
- Use strict typing - no `any` unless absolutely necessary
- Define interfaces in `shared/gameTypes.ts` for shared types
- Use Zod schemas for runtime validation

**React:**
- Use functional components with hooks
- Prefer `trpc.*.useQuery` and `trpc.*.useMutation` for data fetching
- Use optimistic updates for instant feedback
- Keep components small and focused

**Backend:**
- All game logic must be server-authoritative
- Validate all inputs with Zod
- Use tRPC procedures instead of REST endpoints
- Handle errors gracefully with TRPCError

### 5. Security Checklist

Before committing changes that affect security:

- [ ] No API keys or secrets in code
- [ ] All user inputs validated
- [ ] Authentication checked for protected routes
- [ ] No client-side AI exposure
- [ ] Cookies are HttpOnly, Secure, SameSite=Strict
- [ ] Server-side validation for all game actions

## Common Tasks

### Adding a New tRPC Procedure

1. Define input schema with Zod in `server/gameRouter.ts`
2. Implement procedure logic
3. Add database query helper in `server/db.ts` if needed
4. Write vitest test
5. Use in frontend with `trpc.game.yourProcedure.useQuery()` or `.useMutation()`

### Adding a New Page

1. Create component in `client/src/pages/YourPage.tsx`
2. Add route in `client/src/App.tsx`
3. Update navigation if needed
4. Test on mobile and desktop

### Modifying Database Schema

1. Edit `drizzle/schema.ts`
2. Run `pnpm db:push`
3. Update TypeScript types (auto-generated)
4. Update query helpers in `server/db.ts`
5. Update affected tRPC procedures
6. Write migration tests

### Adding WebSocket Events

1. Define event type in `shared/gameTypes.ts`
2. Add handler in `server/websocket.ts`
3. Emit from tRPC procedure or game logic
4. Listen in frontend component with `socket.on()`
5. Test real-time behavior with multiple clients

## Daily Workflow

### Morning Checklist
1. Review `todo.md` for pending tasks
2. Check for any failed tests: `pnpm test`
3. Review recent changes: `git log --oneline -10`
4. Plan today's work and update todo.md

### During Development
1. Make small, focused commits
2. Run tests frequently
3. Update documentation as you go
4. Log progress in commit messages

### Before Ending Day
1. Run full test suite: `pnpm test`
2. Type check: `pnpm check`
3. Update todo.md with completed items
4. Commit all changes
5. Write summary of progress

## Debugging Guide

### Frontend Issues

**Component not rendering:**
```bash
# Check browser console for errors
# Verify tRPC query is successful
# Check React DevTools for component state
```

**WebSocket not connecting:**
```bash
# Check browser Network tab for WebSocket connection
# Verify Socket.IO path: /api/socket.io
# Check server logs for connection events
```

### Backend Issues

**tRPC procedure failing:**
```bash
# Check server logs for error details
# Verify input validation with Zod
# Test database query in isolation
# Check authentication context
```

**Database errors:**
```bash
# Verify schema is up to date: pnpm db:push
# Check DATABASE_URL environment variable
# Test query in MySQL client
# Review Drizzle ORM documentation
```

### Game Logic Issues

**Bingo detection not working:**
```bash
# Run game engine tests: pnpm test server/gameEngine.test.ts
# Check pattern definition in database
# Verify marked tiles array structure
# Test with simplified card
```

## Automation Opportunities

### Automated Testing
- Run tests on every commit
- Add more test coverage for edge cases
- Implement E2E tests with Playwright

### Automated Deployment
- CI/CD pipeline for automatic deployment
- Automated database backups
- Health check monitoring

### Automated Maintenance
- Dependency updates with Renovate
- Code quality checks with ESLint
- Performance monitoring

## Integration Points

### AI Voice Integration

**Location**: `server/aiVoice.ts`

**Providers**: ElevenLabs, Hume, OpenAI

**Environment Variables**:
- `ELEVENLABS_API_KEY`
- `HUME_API_KEY`
- `OPENAI_API_KEY`

**Usage**: Call `getVoiceManager().announceImage()` from game logic

### Manus Platform

**OAuth**: Handled by `server/_core/oauth.ts` (DO NOT MODIFY)

**Environment**: All platform variables auto-injected

**Deployment**: Use Manus UI Publish button after creating checkpoint

## Best Practices

### Code Style
- Use TypeScript strict mode
- Prefer `const` over `let`
- Use async/await over promises
- Comment complex logic
- Keep functions small and focused

### Git Commits
- Use conventional commits: `feat:`, `fix:`, `docs:`, `test:`
- Write clear commit messages
- Commit frequently with logical units of work

### Performance
- Use React.memo for expensive components
- Implement pagination for large lists
- Optimize images (already done for bingo tiles)
- Use WebSocket for real-time, tRPC for CRUD

### Accessibility
- Use semantic HTML
- Add ARIA labels where needed
- Ensure keyboard navigation works
- Test with screen readers

## Emergency Procedures

### Production Issues

1. **Check logs**: Review server logs for errors
2. **Rollback**: Use Manus checkpoint rollback if needed
3. **Hotfix**: Create fix, test locally, deploy immediately
4. **Post-mortem**: Document issue and prevention steps

### Database Issues

1. **Backup**: Ensure recent backup exists
2. **Diagnose**: Check schema, queries, and connections
3. **Fix**: Apply schema fix with `pnpm db:push`
4. **Verify**: Test with sample data

### Security Incidents

1. **Isolate**: Disable affected features immediately
2. **Investigate**: Review logs and code for vulnerability
3. **Patch**: Fix vulnerability and deploy
4. **Notify**: Inform users if data was compromised

## Resources

### Documentation
- [tRPC Docs](https://trpc.io)
- [Drizzle ORM](https://orm.drizzle.team)
- [Socket.IO](https://socket.io/docs)
- [shadcn/ui](https://ui.shadcn.com)

### Internal Docs
- Main README: `/README.md`
- Database Schema: `/drizzle/schema.ts`
- API Reference: See tRPC routers in `/server/`

## Contact & Support

For questions or issues:
1. Review this instruction file
2. Check project README
3. Review relevant documentation
4. Test in isolation
5. Ask for human review if needed

---

**Remember**: This is a production application. Always test thoroughly, maintain security standards, and document your changes. Automate wherever possible to reduce manual work and errors.
