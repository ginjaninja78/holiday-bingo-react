# üéôÔ∏è AI Voice Announcer System - Architecture Design

## Overview
A **modular, standalone** AI voice announcer system for Holiday Bingo that adds personality, humor, and engagement to gameplay using ElevenLabs text-to-speech API.

## Core Principles
1. **MODULAR** - Completely standalone, won't interfere with concurrent development
2. **OPTIONAL** - Can be toggled on/off without breaking core game functionality
3. **COST-CONSCIOUS** - Smart caching and credit optimization
4. **CONTEXT-AWARE** - Maintains session memory for personalized humor
5. **PROFESSIONAL** - Funny but appropriate for corporate environments

---

## System Architecture

### 1. Directory Structure
```
server/announcer/
‚îú‚îÄ‚îÄ index.ts                    # Main announcer service
‚îú‚îÄ‚îÄ elevenlabs.ts              # ElevenLabs API client
‚îú‚îÄ‚îÄ audioCache.ts              # Audio file caching system
‚îú‚îÄ‚îÄ sessionMemory.ts           # Context/memory management
‚îú‚îÄ‚îÄ humorEngine.ts             # Joke generation logic
‚îú‚îÄ‚îÄ musicPlayer.ts             # Holiday music management
‚îî‚îÄ‚îÄ types.ts                   # TypeScript interfaces

client/src/components/announcer/
‚îú‚îÄ‚îÄ AnnouncerControlPanel.tsx  # Settings UI component
‚îú‚îÄ‚îÄ AnnouncerPlayer.tsx        # Audio playback component
‚îú‚îÄ‚îÄ AnnouncerContext.tsx       # React context for state
‚îî‚îÄ‚îÄ announcer.css              # Styling

drizzle/schema-announcer.ts    # Database schema (separate file)

public/music/                   # Holiday music files
‚îú‚îÄ‚îÄ ambient-1.mp3
‚îú‚îÄ‚îÄ ambient-2.mp3
‚îî‚îÄ‚îÄ ...

.env                            # ELEVENLABS_API_KEY
```

### 2. Database Schema (Separate File)

**New Tables:**
- `announcer_settings` - User preferences and toggles
- `announcer_quips` - Humor database per image
- `announcer_cache` - Audio file cache metadata
- `announcer_session_memory` - Context tracking per game session

**No modifications to existing tables** - completely additive!

### 3. API Endpoints (New Router)

```
POST   /api/announcer/speak          # Generate speech
GET    /api/announcer/settings       # Get settings
PUT    /api/announcer/settings       # Update settings
GET    /api/announcer/quips/:imageId # Get quips for image
POST   /api/announcer/session/start  # Start session tracking
PUT    /api/announcer/session/event  # Log gameplay event
GET    /api/announcer/session/memory # Get session context
DELETE /api/announcer/cache          # Clear audio cache
```

### 4. Component Integration Points

**Minimal changes to existing code:**
- Add `<AnnouncerProvider>` wrapper in `App.tsx`
- Add `<AnnouncerControlPanel>` to host dashboard
- Add event hooks in game logic (optional, non-breaking)

---

## Feature Specifications

### 1. Voice Announcer Capabilities

#### A. Game Introduction
- **Trigger:** Game launch (if enabled)
- **Content:** "Welcome to Holiday Bingo! I'm your AI host for today. Let's spread some holiday cheer and maybe a little chaos!"
- **Music:** Fade in holiday music after intro

#### B. Card Announcements
- **Trigger:** Host reveals a card
- **Content:** 
  - Image description
  - Observational humor from database
  - Occasional AI self-aware jokes
- **Example:** "Ah, a frosted window pane! Notice how one side shows a cozy room and the other shows the outdoors? Even AI image generators get confused about windows sometimes!"

#### C. Host Nudging
- **Trigger:** 10+ seconds of inactivity
- **Content:** Gentle, humorous prompts
- **Examples:**
  - "Take your time, no pressure... except from the 47 people waiting!"
  - "Did you fall asleep? Should I play some elevator music?"
  - "I've seen paint dry faster, but hey, I'm just an AI!"

#### D. Winner Announcements
- **Trigger:** Player wins
- **Content:** Contextual jokes based on session memory
- **Examples:**
  - "Congratulations Martha! That's your 5th win today. You might have enough points for a coffee! Don't spend it all in one place!"
  - "John wins again! At this rate, we should just rename the game 'John's Bingo Domination Hour'!"
  - "First-time winner Sarah! Welcome to the winners circle. Population: you and Martha's ego!"

#### E. AI Self-Aware Humor
- **Trigger:** Random intervals or specific image quirks
- **Examples:**
  - "As an AI, I find it hilarious that you humans need me to read pictures to you. What's next, describing memes?"
  - "This image was probably generated by my cousin, DALL-E. We don't talk much after the 'hand incident'."
  - "I'm powered by ElevenLabs, which means I sound human but I'm still not allowed to have opinions about pineapple on pizza."

### 2. Holiday Music System

#### Music Triggers
- **Game start:** Fade in ambient holiday music (low volume)
- **Between games:** Increase volume, play more upbeat tracks
- **During gameplay:** Lower volume, subtle background
- **Lulls in action:** Fade up slightly
- **Game end:** Celebratory track

#### Music Library
- 5-10 royalty-free holiday instrumentals
- Categorized by mood: ambient, upbeat, celebratory
- Seamless looping and crossfading

### 3. Cost Optimization

#### Audio Caching Strategy
1. **Cache all generated speech** with hash of text + voice settings
2. **Persistent cache** in database and filesystem
3. **Pre-generate common phrases** on first launch
4. **Reuse cached audio** for identical announcements

#### Smart Generation
- **Batch requests** when possible
- **Skip announcements** if disabled mid-game
- **Queue management** to prevent duplicate requests
- **Fallback to text** if API fails or credits exhausted

#### Estimated Costs
- **ElevenLabs Free Tier:** 10,000 characters/month
- **Average announcement:** 100-200 characters
- **With caching:** ~50-100 unique announcements needed
- **Monthly cost:** $0 (free tier) or $5 (starter tier)

### 4. Control Panel Features

#### Settings Toggles
- ‚úÖ **Enable/Disable Announcer** (master switch)
- ‚úÖ **Game Intro** (on/off)
- ‚úÖ **Card Announcements** (on/off)
- ‚úÖ **Host Nudging** (on/off)
- ‚úÖ **Winner Announcements** (on/off)
- ‚úÖ **Background Music** (on/off)
- ‚úÖ **Music Volume** (0-100%)
- ‚úÖ **Voice Volume** (0-100%)
- ‚úÖ **Humor Level** (professional / sparky / roast mode)
- ‚úÖ **Nudge Delay** (5s / 10s / 15s / never)

#### Voice Selection
- Choose from ElevenLabs voices
- Preview each voice
- Save preference per host

#### Cache Management
- View cache size
- Clear cache button
- Pre-generate common phrases

### 5. Session Memory & Context

#### Tracked Data
- **Player wins** - Count per player
- **Game duration** - Time elapsed
- **Host behavior** - Response time patterns
- **Image reveals** - Which cards shown
- **Previous jokes** - Avoid repetition

#### Contextual Humor
- **First win:** Encouraging
- **Multiple wins:** Playful teasing
- **Losing streak:** Supportive humor
- **Slow host:** Escalating nudges
- **Fast host:** Impressed comments

---

## Database Schema Details

### Table: `announcer_settings`
```sql
CREATE TABLE announcer_settings (
  id INTEGER PRIMARY KEY,
  user_id TEXT,
  enabled BOOLEAN DEFAULT true,
  game_intro BOOLEAN DEFAULT true,
  card_announcements BOOLEAN DEFAULT true,
  host_nudging BOOLEAN DEFAULT true,
  winner_announcements BOOLEAN DEFAULT true,
  background_music BOOLEAN DEFAULT true,
  music_volume INTEGER DEFAULT 30,
  voice_volume INTEGER DEFAULT 80,
  humor_level TEXT DEFAULT 'sparky',
  nudge_delay INTEGER DEFAULT 10,
  voice_id TEXT,
  created_at INTEGER DEFAULT (unixepoch()),
  updated_at INTEGER DEFAULT (unixepoch())
);
```

### Table: `announcer_quips`
```sql
CREATE TABLE announcer_quips (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  image_id INTEGER REFERENCES gallery_images(id),
  quip_text TEXT NOT NULL,
  quip_type TEXT DEFAULT 'observational',
  humor_level TEXT DEFAULT 'professional',
  created_at INTEGER DEFAULT (unixepoch())
);
```

### Table: `announcer_cache`
```sql
CREATE TABLE announcer_cache (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  text_hash TEXT UNIQUE NOT NULL,
  voice_id TEXT NOT NULL,
  audio_file_path TEXT NOT NULL,
  file_size INTEGER,
  duration_ms INTEGER,
  created_at INTEGER DEFAULT (unixepoch()),
  last_used_at INTEGER DEFAULT (unixepoch()),
  use_count INTEGER DEFAULT 0
);
```

### Table: `announcer_session_memory`
```sql
CREATE TABLE announcer_session_memory (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL,
  event_type TEXT NOT NULL,
  event_data TEXT,
  timestamp INTEGER DEFAULT (unixepoch())
);
```

---

## Integration Guide

### Step 1: Install Dependencies
```bash
pnpm add elevenlabs @types/elevenlabs
```

### Step 2: Add Environment Variable
```bash
# .env
ELEVENLABS_API_KEY=your_api_key_here
```

### Step 3: Run Database Migration
```bash
pnpm tsx scripts/migrate-announcer.ts
```

### Step 4: Seed Humor Database
```bash
pnpm tsx scripts/seed-announcer-quips.ts
```

### Step 5: Add to App (Optional)
```tsx
// client/src/App.tsx
import { AnnouncerProvider } from './components/announcer/AnnouncerContext';

function App() {
  return (
    <AnnouncerProvider>
      {/* existing app code */}
    </AnnouncerProvider>
  );
}
```

### Step 6: Add Control Panel to Dashboard
```tsx
// client/src/pages/HostDashboard.tsx
import { AnnouncerControlPanel } from '../components/announcer/AnnouncerControlPanel';

// Add to dashboard UI
<AnnouncerControlPanel />
```

---

## Event Hooks (Optional)

To enable announcer reactions, add these hooks to game logic:

```typescript
// When card is revealed
announcer.announceCard(imageId);

// When player wins
announcer.announceWinner(playerName, winCount);

// When game starts
announcer.startGame();

// When game ends
announcer.endGame();
```

**These are OPTIONAL** - announcer works standalone without them!

---

## Testing Strategy

### Unit Tests
- Audio caching logic
- Humor selection algorithm
- Session memory tracking
- Cost optimization calculations

### Integration Tests
- ElevenLabs API calls
- Database operations
- Audio playback
- Music crossfading

### Manual Testing
- Play full game with announcer enabled
- Test all toggle combinations
- Verify cost optimization (check cache hits)
- Confirm no interference with core game

---

## Rollback Plan

If announcer causes issues:

1. **Disable via toggle** - No code changes needed
2. **Remove component** - Delete `<AnnouncerProvider>` wrapper
3. **Drop tables** - `DROP TABLE announcer_*`
4. **Delete files** - Remove `server/announcer/` and `client/src/components/announcer/`

**Core game functionality remains 100% intact!**

---

## Future Enhancements

- **Voice cloning** - Upload custom voice
- **Multi-language** - Support for different languages
- **Custom quips** - Let hosts add their own jokes
- **Voice effects** - Reverb, pitch shift for variety
- **Audience reactions** - Applause, laughter sound effects
- **Live TTS** - Real-time speech generation for dynamic content

---

## Cost Projections

### ElevenLabs Pricing
- **Free:** 10,000 chars/month
- **Starter:** $5/month - 30,000 chars
- **Creator:** $22/month - 100,000 chars

### Usage Estimates (with caching)
- **Small game (10 players):** ~5,000 chars
- **Medium game (50 players):** ~15,000 chars
- **Large game (200 players):** ~40,000 chars

### Recommendation
Start with **free tier**, upgrade to **Starter ($5/mo)** if needed.

---

## Status: READY TO BUILD ‚úÖ

This architecture ensures:
‚úÖ **Modular** - Standalone, non-breaking
‚úÖ **Optional** - Toggle on/off anytime
‚úÖ **Cost-effective** - Smart caching
‚úÖ **Funny** - Professional humor
‚úÖ **Context-aware** - Session memory
‚úÖ **Well-documented** - Comprehensive guides
