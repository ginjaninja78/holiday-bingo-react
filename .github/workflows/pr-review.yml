name: PR Auto-Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  review:
    name: Automated PR Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check PR title format
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request.title;
            const validPrefixes = ['feat:', 'fix:', 'docs:', 'test:', 'refactor:', 'chore:'];
            const hasValidPrefix = validPrefixes.some(prefix => title.startsWith(prefix));
            
            if (!hasValidPrefix) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: 'âš ï¸ PR title should start with: feat:, fix:, docs:, test:, refactor:, or chore:'
              });
            }
      
      - name: Check for MASTER-TODO reference
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const hasTodoReference = body.includes('MASTER-TODO.md') || body.includes('TODO');
            
            if (!hasTodoReference) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: 'ðŸ’¡ Consider referencing the related task in MASTER-TODO.md'
              });
            }
      
      - name: Check for test files
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const hasServerChanges = files.data.some(f => f.filename.startsWith('server/') && f.filename.endsWith('.ts'));
            const hasTestChanges = files.data.some(f => f.filename.includes('.test.ts'));
            
            if (hasServerChanges && !hasTestChanges) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: 'âš ï¸ Server code changes detected but no test files added. Consider adding tests.'
              });
            }
      
      - name: Check for breaking changes
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const hasSchemaChanges = files.data.some(f => f.filename.includes('schema.ts'));
            const hasRouterChanges = files.data.some(f => f.filename.includes('Router.ts') || f.filename === 'server/routers.ts');
            
            if (hasSchemaChanges) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: 'âš ï¸ **Database schema changes detected!** Ensure you ran `pnpm db:push` and tested migrations.'
              });
            }
            
            if (hasRouterChanges) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: 'ðŸ’¡ tRPC router changes detected. Verify frontend uses new procedures correctly.'
              });
            }
      
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const totalChanges = files.data.reduce((sum, f) => sum + f.changes, 0);
            
            if (totalChanges > 500) {
              github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                event: 'COMMENT',
                body: `âš ï¸ Large PR detected (${totalChanges} changes). Consider breaking into smaller PRs for easier review.`
              });
            }
      
      - name: Add labels based on files changed
        uses: actions/github-script@v7
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            
            const labels = [];
            
            if (files.data.some(f => f.filename.startsWith('client/'))) {
              labels.push('frontend');
            }
            if (files.data.some(f => f.filename.startsWith('server/'))) {
              labels.push('backend');
            }
            if (files.data.some(f => f.filename.includes('schema.ts'))) {
              labels.push('database');
            }
            if (files.data.some(f => f.filename.includes('.test.ts'))) {
              labels.push('testing');
            }
            if (files.data.some(f => f.filename.startsWith('docs/'))) {
              labels.push('documentation');
            }
            
            if (labels.length > 0) {
              github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                labels: labels
              });
            }
